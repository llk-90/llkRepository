<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>掌踪宝</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <!--mui.css文件引入-->
    <link rel="stylesheet" href="../../css/mui.min.css">

    <!--地图自带css、js-->
    <link rel="stylesheet" type="text/css" href="../../css/app/zhangzongbao/fence/iBaby.fence_update.css">
    <link rel="stylesheet" type="text/css" href="../../css/app/zhangzongbao/Palm_treasure.css">

    <link href="../../css/mui.picker.css" rel="stylesheet" />

    <link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>


    <script src="../../js/app/common/cvi_busy_lib.js"></script>
    <script src="../../js/app/zhangzongbao/fency/mui.min.js"></script>
    <script src="../../js/app/zhangzongbao/fency/iBaby2.jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="../../js/app/common/Common.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=1.3&key=58bcf024f9b7930fc2a43b3554b1672b"></script>
    <script type="text/javascript" src="../../js/app/zhangzongbao/fency/iBaby.fence_update.js"></script>
    <style type="text/css">
        body, html {
            width: 100%;
            height: 100%;
            margin: 0;
            font-family: "微软雅黑";
        }

        #allmap {
            width: 100%;
            height: 100%;
        }
        li{
            border:none;
        }

    </style>
</head>
<body class="body" onload="trackInfo();">

    <div id="allmap">
        <div style="border:1px solid #e1e1e0;box-shadow: 0px -1px 3px #e1e1e0;height:64px;-webkit-border-radius: 2px;-moz-border-radius: 2px;border-radius: 2px;width:94%;margin-top: -5px;position: relative;top:20px;left:3%;z-index: 999;background-color:white;">
            <img  id="child-img" src="../../img/zhangzongbao/toux.jpg" alt="头像">
            <span id="child-name"></span>
            <img id="child-img-status1" src="../../img/zhangzongbao/cha.png" alt="">
            <span id="child-span-tatus1" style="color: #2ac845"></span>
        </div>

        <div id="two">
            <div class="mui-input-row" style="border-bottom:0px solid red;height:52px;">
                <label class="lable" style="border:0px solid red;width:56px;height:52px;padding:0;"><img src="../../img/zhangzongbao/location.png" alt="标签"></label>
                <label class="lable" style="border:0px solid red;width:70%;height:58px;padding:0;">
                    <span id="localtion" style="border:0px solid red;display: block;height: 58px;line-height: 58px;font-size:15px;color: #6d6f79">深圳市罗湖区泥岗中路</span>
                </label>
            </div>
            <hr style="margin:0;padding:0;width:90%;margin-left: 5%;height:1px;border: 0;background-color:#ecf0ed;">
            <div class="mui-input-row" style="border:0px solid red;height:52px;">
                <label class="lable" style="border:0px solid red;width:56px;height:52px;padding:0;"><img style="width:20px;height:20px;margin-top:16px;margin-left:20px;" src="../../img/zhangzongbao/clock.png" alt="标签"></label>
                <label class="lable" style="border:0px solid red;width:70%;height:52px;padding:0;">
                    <span id="time" style="display: block;height: 52px;line-height: 52px;font-size:15px;color: #6d6f79">11月13日&nbsp;&nbsp;&nbsp;15:28</span>
                </label>

            </div>
        </div>
        <!--<div style="border:1px solid #e1e1e0;box-shadow: 0px -1px 1px #e1e1e0;-webkit-border-radius: 2px;-moz-border-radius: 2px;text-align:center;border-radius: 2px;width:94%;height:48px;position: absolute;bottom:0;left:3%;z-index: 999;background-color:white;">-->
            <!--<span style="display:block;height: 48px;line-height: 48px;"><img src="../../img/zhangzongbao/sshang.png" alt="上滑" style="width:30px;height:30px;margin-top:9px;"></span>-->
        <!--</div>-->
        <div id="three" >
            <div style="width:100%;height:9%;text-align:center;border: 0px solid red;margin-top:7px;">
                <a href="javascript:void(0);" onclick="nnno()" style="display:block;height:100%;line-height:100%;"><img id="zzou" src="../../img/zhangzongbao/sshang.png" alt="上滑" style="width:28px;height:28px;margin-top:auto;margin-bottom:auto;"></a>
            </div>
            <div id="jiugong">
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(0)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-1.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">定位轨迹</span>
                </div>
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(1)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-2.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">电子围栏</span>
                </div>
                <div class="jgg" onclick="jumpPage(2)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-3.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">安全健康</span>
                </div>
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(3)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-4.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">掌踪宝</span>
                </div>
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(4)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-5.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">绑定切换</span>
                </div>
                <div class="jgg" onclick="jumpPage(5)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-6.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">号码管理</span>
                </div>
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(6)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-7.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">校园管理</span>
                </div>
                <div class="jgg" style="margin-right:5%;" onclick="jumpPage(7)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-8.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">系统设置</span>
                </div>
                <div class="jgg" onclick="jumpPage(8)">
                    <div class="jgg-img"><img src="../../img/zhangzongbao/a-9.png" alt="" style="width:100%;height:100%;"></div>
                    <span class="jgg-span">远程遥控</span>
                </div>
            </div>

        </div>

        <div id="four">
            <span id="four-span" style="display:block;height:90%;font-size:12px;color:#e1e1e0;margin-top: 1px;">
                Copyright&nbsp;©&nbsp;2017&nbsp;ZhangshangguanaiLtd.All&nbsp;rights reserved
            </span>
        </div>
    </div>

    <script>

    var imgSrc;
    var childName;
        //高德地图对象
        var map;
        var marker;
        var icon = "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png";
        map = new AMap.Map('allmap', {
            zoom: 12
        });
        map.plugin(["AMap.ToolBar"], function() {
            var scale = new AMap.ToolBar({
                position:'LB'
            });
            map.addControl(scale);
        });
        var stat = "load";
        var cout = 0;

        function tishi(){

            if(stat == "start"){
                stat = "none";
            } else if(stat == "exit" || stat == "load"){
                stat = "start";
            }
            $("#tishikuang").hide(500);
            $("#allmap").css("height","80%");

            timer = window.setTimeout("tishi()", 5000);
            cout++;
            if (cout>=12){stat = "keep";cout=0}
            trackInfo();
        }
        function tishi2(){
            if (timer) {
                window.clearTimeout(timer);
            }
            stat = "exit";
            cout=0;
            $("#tishikuang").show(500);
            $("#allmap").css("height","60%");
            trackInfo();
        }

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if(r != null) return unescape(r[2]);
            return null;
        }

        function trackInfo() {

            var stuid = GetQueryString('stuid');
            var openid = GetQueryString('openid');
            var d = {
                openid: openid,
                stuId: studentuserinfo.stuId,
                stat: stat
            };
            setTimeout(function() {
                $.ajax(baseURL+"/zhangzongbao/terminalStatusApp/terminalStatus.webapp", {
                    data: d,
                    dataType: 'json', //服务器返回json格式数据
                    type: 'post', //HTTP请求类型
                    timeout: 10000, //超时时间设置为10秒；
                    success: function(data) {
                        var statCode = data.statCode;//返回值
                        var Lat = data.lat;//纬度
                        var Lng = data.lng;//经度

                        var speed = data.speed;
                        var updateTime = data.updateTime;
                        var isGps = data.isGps;

                        if ( statCode == '200' ) {
//			        	var point = new BMap.Point(Lng, Lat);
//			    		map.centerAndZoom(point, 17);
//			    		var marker = new BMap.Marker(point);  // 创建标注
//			    		map.addOverlay(marker);               // 将标注添加到地图中
                            marker = new AMap.Marker({
                                icon: icon,
                                position: [Lng,Lat],
                                map: map
                            });
                            map.setFitView();
                            openInfo(speed,updateTime,isGps,Lng,Lat);
                        }else{
                            mui.toast("请求数据失败");
                        }
                    },
                    error: function(xhr, type, errorThrown) {

                    }
                });
            }, 100);
        }




        var two = document.getElementById("two");
        var three = document.getElementById("three");
        var four = document.getElementById("four");
        var zzou = document.getElementById("zzou");
        var fourSpan = document.getElementById("four-span");
        var jiugong = document.getElementById("jiugong");
        var height = document.body.clientHeight;
        var width = document.body.clientWidth;
        var studentuserinfo;
        var openid ;
        jiugong.style.display="none";
        //初始化函数
        $(function(){
            initUserInfo();
            initInfo();
        })

        if(four.style.display=="none"){
            four.style.display="block";
        }
        else{
            four.style.display="none";
        }
        console.log( two.offsetTop);
        function nnno() {
            if(two.offsetTop<300){
                jiugong.style.display="none";
                two.style.top = height*0.7+'px';
                three.style.top = height*0.93+'px';
                four.style.display="none";
                zzou.src='../../img/zhangzongbao/sshang.png';

            }else{
                jiugong.style.display="block";
                two.style.top = height*0.18+'px';
                three.style.top = height*0.45+'px';
                four.style.display="block";
                zzou.src='../../img/zhangzongbao/xxia.png';
            }

        }

        function jumpPage(type){
		switch(type){
		case 0:{
			window.location.href = "../../html/zhangzongbao/iBaby.location.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 1:{
			window.location.href = "../../html/zhangzongbao/eleFenceSet.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 2:{
			window.location.href = "../../html/zhangzongbao/PalmSecurity.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
            case 3:{
                window.location.href = "../../html/zhangzongbao/iBaby.bind.html?openid=" + openid;
            }
                break;
		case 4:{
			window.location.href = "../../html/zhangzongbao/iBaby.bindChange.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 5:{
			window.location.href = "../../html/zhangzongbao/treasure_number.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 6:{
			window.location.href = "../../html/zhangzongbao/PalmSchool.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 7:{
			window.location.href = "../../html/zhangzongbao/iBaby.sysset.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
		case 8:{
			window.location.href = "../../html/zhangzongbao/iBaby.romote.html?openid=" + openid + "&" + "stuid=" + studentuserinfo.stuId;
		}
		break;
	}
}
            //初始化userinfo
            function initUserInfo() {

                openid = GetQueryString('openid');
                var stuid = GetQueryString('stuid');

                studentuserinfo = new Object();

                studentuserinfo.stuId=stuid;//宝贝学号
                studentuserinfo.userIcon="";//用户头像
                studentuserinfo.name="";//用户名称
                studentuserinfo.connectAds="";//联系地址
                studentuserinfo.lastConnectTime="";//最后通讯时间
                studentuserinfo.isConnect="";//是否通讯中设备
                studentuserinfo.recivesState="";//当前收信息状态
                studentuserinfo.locatState="";//定位方式
//        studentuserinfo.locationNum="";//轨迹数
//        studentuserinfo.weilanNum="5";//围栏数
                studentuserinfo.isProtect="";//是否在保
//        studentuserinfo.isBangDing=true;//是否绑定
//        studentuserinfo.isPay=false;//是否已经支付
            }

            //跳转二级页面

            function GetQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if(r != null) return unescape(r[2]);
                return null;
            }

            //发起网络请求
            function initInfo() {
               var openId  =  GetQueryString('openid');
      		 var xval=getBusyOverlay('viewport',{color:'white', opacity:0.75, text:'加载中', style:'text-shadow: 0 0 3px black;font-weight:bold;font-size:16px;color:white'},{color:'#59bf6b', size:70, type:'o'});
         	mui.ajax(baseURL+"/zhangzongbao/addchildInfo/babyInfo.webapp", {
             data:{
                 openid : openId
             },
             dataType: 'json', //服务器返回json格式数据
             type: 'post', //HTTP请求类型
             timeout: 10000, //超时时间设置为10秒；
             async:false,
             beforeSend:function(){
            if(xval) {
                     xval.settext("加载中，请稍后......");
                 } 
             }, 
             success: function(data) {
                 xval.remove();
                 console.log(data)
                 if(data.result == "success"){
                     imgSrc = data.babyInfo.ibaby_s_img;
                     childName = data.babyInfo.ibaby_s_name;
                     configPage(data.babyInfo);
                 } else if(data.result == "empty"){
                	setTimeout(
                    window.location.href= "iBaby.bind.html?openid=" + openId
                			,60000);
                 } else {
                     mui.toast(data.result.replace(/注册/,"激活"))
                 }
             },
             error: function(xhr, type, errorThrown) {
                 mui.toast("服务器正在维护，请稍后重试！")
             }

         });
   } 
            //生成对应模型,服务器获取json后调用

            function unachreveModel(temp) {
                studentuserinfo.stuId=temp.ibaby_s_id;//宝贝学号
                studentuserinfo.userIcon=temp.ibaby_s_img;//用户头像
                studentuserinfo.name=temp.ibaby_s_name;//用户名称
                studentuserinfo.connectAds=temp.connectAds;//联系地址
                studentuserinfo.lastConnectTime=temp.lastConnectTime;//最后通讯时间
                studentuserinfo.isConnect=temp.ibaby_equ_status;//是否通讯中设备
                studentuserinfo.recivesState=temp.recivesState;//当前收信息状态
                studentuserinfo.locatState=temp.locatState;//定位方式
//        studentuserinfo.locationNum=temp.locationNum;//轨迹数
//        studentuserinfo.weilanNum=temp.weilanNum;//围栏数
                studentuserinfo.isProtect=temp.isProtect;//是否在保
                //studentuserinfo.isBangDing=temp.isBangDing;//是否绑定
            }

            //根据本地模型初始化页面
            function configPage(temp) {
                unachreveModel(temp);
                //初始化头像
                //$("#icon").attr("src",studentuserinfo.userIcon.getUrl());
                $("#child-img").attr("src",studentuserinfo.userIcon);
                //配置姓名
                document.getElementById("child-name").innerText = studentuserinfo.name;
                //配置通讯状态
                switch (studentuserinfo.isConnect)
                {
                    case '0':
                    {
                        document.getElementById("child-span-tatus1").innerText = "通讯中";
                    }
                        break;
                    case '1':
                    {
                        document.getElementById("child-span-tatus1").innerText = "通讯中断";
                    }
                        break;
                    case '3':
                    {
                        document.getElementById("child-span-tatus1").innerText = "维修中";
                    }
                        break;
                }
//        //配置支付信息
//        if(temp.ibaby_pay_state!="0" && temp.ibaby_pay_state!=""){
//        	studentuserinfo.isPay=true;
//        }else{
//        	studentuserinfo.isPay=false;
//        }
                //配置收信状态
//                switch (studentuserinfo.recivesState)
//                {
//                    case '0':
//                    {
//                        document.getElementById("reviveState").innerText = "应学校要求，上课期间拒绝所有来电";
//                    }
//                        break;
//                    /*            case '1':
//                     {
//                     document.getElementById("reviveState").innerText = "上课期间，仅允许家长亲情号来电";
//                     }
//                     break;*/
//                }
                //配置地址
                document.getElementById("localtion").innerText = studentuserinfo.connectAds;
                console.log(studentuserinfo.connectAds);
                //配置时间
                //var connectTime = new Date(studentuserinfo.lastConnectTime.replace(/-/g,'/'));
                //document.getElementById("lasttime").innerText = (connectTime.getMonth()+1) + "月" + connectTime.getDate() + "日 " + connectTime.getHours() + ":" +connectTime.getMinutes();
                document.getElementById("time").innerText = studentuserinfo.lastConnectTime.substring(5,7) + "月" + studentuserinfo.lastConnectTime.substring(8,10) + "日 " + studentuserinfo.lastConnectTime.substring(11,13) + ":" +studentuserinfo.lastConnectTime.substring(14,16);
                //配置定位方式
//                switch (studentuserinfo.locatState)
//                {
//                    case '1':
//                    {
//                        document.getElementById("positionstyle").innerText = "GPS定位";
//                    }
//                        break;
//                    case '0':
//                    {
//                        document.getElementById("positionstyle").innerText = "基站定位";
//                    }
//                        break;
//                    case '8':
//                    {
//                        document.getElementById("positionstyle").innerText = "wifi定位";
//                    }
//                        break;
//                }
//         //配置轨迹数
//        var str = studentuserinfo.locationNum.length;
//        str = 6 - str;
//        for (var i= 0;i<str;i++) {
//        	studentuserinfo.locationNum = studentuserinfo.locationNum + "&ensp;"
//        }
//        var str2 = studentuserinfo.weilanNum.length;
//        str2 = 6 - str2;
//        for (var i= 0;i<str;i++) {
//        	studentuserinfo.weilanNum = studentuserinfo.weilanNum + "&ensp;"
//        }
//        document.getElementById("guijinum").innerHTML = "<img src='../iBaby/images/iBaby.index/dingweiguiji.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>" + studentuserinfo.locationNum ;
//        //配置围栏数
//        document.getElementById("weilannum").innerHTML = "<img src='../iBaby/images/iBaby.index/dianziweilan.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>" + studentuserinfo.weilanNum;
                //配置是否在保
//                document.getElementById("protect").innerHTML = studentuserinfo.isProtect==false?"<img src='../iBaby/images/iBaby.index/zaibaoqi.png' style='max-height: 17px;max-width: 17px;margin-bottom:-6px'>"+"    <font style:'margin-bottom：-10px'>    在保期</font>"
//                        :"<img src='../iBaby/images/iBaby.index/zaibaoqi.png' style='max-height: 17px;max-width: 17px;margin-bottom:-6px'>"+"    已过保";
//        //配置是否绑定
//        document.getElementById("bindnum").innerHTML = studentuserinfo.isBangDing==true?"<img src='../iBaby/images/iBaby.index/yibangding.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>"+"已绑定"
//        		:"<img src='../iBaby/images/iBaby.index/yibangding.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>"+"未绑定";
//        //配置是否支付
//        document.getElementById("pay").innerHTML = studentuserinfo.isPay==true?"<img src='../iBaby/images/iBaby.index/zhifu1.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>"+"已购买":
//        	"<img src='../iBaby/images/iBaby.index/zhifu1.png' style='max-height: 15px;max-width: 15px;margin-bottom:-2px;'>"+"未购买";
            }

            function showToast(text) {
                $("#tsk").show();
                $("#tsk").text(text);
                setTimeout("hiddenToast()", 2000);
            }
            //隐藏Toast窗体
            function hiddenToast() {
                $("#tsk").hide();
            }

        /* -----------------------------获取定位信息  ----------------------------- -*/
        //显示窗口信息
        function openInfo(speed,time,model,lng,lat) {
            if (model == 1) {
                model = "GPS卫星定位";
            } else if(model == 0){
                model = "基站定位";
            } else {
                model = "wifi定位";
            }
            //构建信息窗体中显示的内容
            var info = [];
            info.push("<div><div><img style=\"float:left;\" src=\" http://webapi.amap.com/images/autonavi.png \"/></div> ");
            info.push("<div style=\"padding:0px 0px 0px 4px;font-size: 12px;\"><b>速度:</b>"+speed +" km/h");
            info.push("<b>时间:</b>"+time);
            info.push("<b>定位:</b>"+model+"</div>");
            infoWindow = new AMap.InfoWindow({
                content: info.join("<br/>"),  //使用默认信息窗体框样式，显示信息内容
                offset: new AMap.Pixel(13, -26)
            });
            infoWindow.open(map, [lng,lat]);
        }

        //监听返回时触发关闭追踪事件
        $(function(){
            pushHistory();
            window.addEventListener("popstate", function(e) {
                tishi2();
            }, false);
            function pushHistory() {
                var state = {
                    title: "title",
                    url: "#"
                };
                window.history.pushState(state, "title", "#");
            }
        });


    </script>

</body>
</html>